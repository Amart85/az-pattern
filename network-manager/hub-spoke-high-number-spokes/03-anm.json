{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "subscriptions": {
            "type": "array",
            "defaultValue": [
                "[concat('/subscriptions/',subscription().subscriptionId)]"
            ],
            "metadata": {
                "description": "subscription array"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location for all Network Manager."
            }
        },
        "networkManagerName": {
            "type": "string",
            "defaultValue": "ntw-mgr1",
            "metadata": {
                "description": "The name for Network Manager"
            }
        },
        "networkConnenctivtyConfigurationName": {
            "type": "string",
            "defaultValue": "netcfg1",
            "metadata": {
                "description": "network connectivty configuration"
            }
        },
        "resourceGroupNameVNets": {
            "type": "string",
            "defaultValue": "[resourceGroup().name]",
            "metadata": {
                "description": "name of the resource group with deployment of vnet1"
            }
        },
        "hubvnetName": {
            "type": "string",
            "defaultValue": "hub",
            "metadata": {
                "description": "name of the  hub vnet"
            }
        },
        "numSpokes": {
            "type": "int",
            "defaultValue": 203,
            "minValue": 1,
            "maxValue": 449,
            "metadata": {
                "description": "number of spoke vnets"
            }
        }
    },
    "variables": {
        "empty": [],
        "firstOctet": 10,
        "secondOctet": 0,
        "thirdOctet": 0,
        "num": 5,
        "numGroups": "[div(parameters('numSpokes'), variables('num'))]",
        "hubvnet": {
            "resourceGroupName": "[parameters('resourceGroupNameVNets')]",
            "name": "[parameters('hubvnetName')]"
        },

        "rounddown": "[mul(variables('numGroups'),variables('num'))]",
        "copy": [
            {
                "name": "appliesToGroups",
                "count": "[add(variables('numGroups'),1)]",
                "input": {
                    "networkGroupId": "[resourceId(subscription().subscriptionId, resourceGroup().name, 'Microsoft.Network/networkManagers/networkGroups', parameters('networkManagerName'),   concat ('grp',padleft(string(copyIndex('appliesToGroups')) , 3,'0'))      )]",
                    "useHubGateway": false,
                    "groupConnectivity": "DirectlyConnected",
                    "isGlobal": "False"
                }
            },
            {
                "name": "lastGroup",
                "count": "[sub(parameters('numSpokes'), variables('rounddown')  ) ]",
                "input": {
                    "resourceId": "[resourceId( subscription().subscriptionId, parameters('resourceGroupNameVNets'), 'Microsoft.Network/virtualNetworks', concat('spoke-', padleft(string( add(variables('secondOctet'),div(   add(variables('num'),copyIndex('lastGroup'))    ,256 )) ), 3,'0'),'-', padleft( string(mod(  add(variables('rounddown'),copyIndex('lastGroup'))  ,256)), 3,'0')   ) )]"
                }
            }
        ]
    },
    "resources": [
        {
            "name": "[parameters('networkManagerName')]",
            "type": "Microsoft.Network/networkManagers",
            "apiVersion": "2021-02-01-preview",
            "location": "[parameters('location')]",
            "properties": {
                "displayName": "[parameters('networkManagerName')]",
                "description": "basic Network Manager",
                "networkManagerScopes": {
                    "subscriptions": "[if(not(empty(parameters('subscriptions'))), parameters('subscriptions'), variables('empty'))]"
                },
                "networkManagerScopeAccesses": [
                    "Connectivity"
                ]
            }
        },
        {
            "name": "[concat(parameters('networkManagerName'), '/',  concat ('grp',padleft(string(copyIndex()) , 3,'0'))   )]",
            "type": "Microsoft.Network/networkManagers/networkGroups",
            "apiVersion": "2021-02-01-preview",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkManagers', parameters('networkManagerName'))]"
            ],
            "copy": {
                "name": "networkGroupCopy",
                "count": "[variables('numGroups')]"
            },
            "properties": {
                "displayName": "[concat('grp',padleft(string(copyIndex()) , 3,'0') )]",
                "description": "[concat('network group',padleft(string(copyIndex()) , 3,'0') )]",
                "groupMembers": [
                    {
                        "resourceId": "[resourceId( subscription().subscriptionId, parameters('resourceGroupNameVNets'), 'Microsoft.Network/virtualNetworks', concat('spoke-', padleft(string( add(variables('secondOctet'),div(   add(0,mul(variables('num'),copyIndex()))   ,256 )) ), 3,'0'),'-', padleft( string(mod(   add(0,mul(variables('num'),copyIndex()))  ,256)), 3,'0') ) )]"
                    },
                    {
                        "resourceId": "[resourceId( subscription().subscriptionId, parameters('resourceGroupNameVNets'), 'Microsoft.Network/virtualNetworks', concat('spoke-', padleft(string( add(variables('secondOctet'),div(   add(1,mul(variables('num'),copyIndex()))   ,256 )) ), 3,'0'),'-', padleft( string(mod(   add(1,mul(variables('num'),copyIndex()))  ,256)), 3,'0') )  )]"
                    },
                    {
                        "resourceId": "[resourceId( subscription().subscriptionId, parameters('resourceGroupNameVNets'), 'Microsoft.Network/virtualNetworks', concat('spoke-', padleft(string( add(variables('secondOctet'),div(   add(2,mul(variables('num'),copyIndex()))    ,256 )) ), 3,'0'),'-', padleft( string(mod(   add(2,mul(variables('num'),copyIndex()))  ,256)), 3,'0')   ) )]"
                    },
                    {
                        "resourceId": "[resourceId( subscription().subscriptionId, parameters('resourceGroupNameVNets'), 'Microsoft.Network/virtualNetworks', concat('spoke-', padleft(string( add(variables('secondOctet'),div(   add(3,mul(variables('num'),copyIndex()))    ,256 )) ), 3,'0'),'-', padleft( string(mod(   add(3,mul(variables('num'),copyIndex()))  ,256)), 3,'0')   ) )]"
                    },
                    {
                        "resourceId": "[resourceId( subscription().subscriptionId, parameters('resourceGroupNameVNets'), 'Microsoft.Network/virtualNetworks', concat('spoke-', padleft(string( add(variables('secondOctet'),div(   add(4,mul(variables('num'),copyIndex()))    ,256 )) ), 3,'0'),'-', padleft( string(mod(   add(4,mul(variables('num'),copyIndex()))  ,256)), 3,'0')   ) )]"
                    }
                ],
                "conditionalMembership": ""
            }
        },
        {
            "name": "[concat(parameters('networkManagerName'), '/',  concat ('grp',padleft(string(variables('numGroups')) , 3,'0'))   )]",
            "type": "Microsoft.Network/networkManagers/networkGroups",
            "apiVersion": "2021-02-01-preview",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkManagers', parameters('networkManagerName'))]"
            ],
            "properties": {
                "displayName": "[concat('grp',padleft(string(variables('numGroups')) , 3,'0') )]",
                "description": "[concat('network group',padleft(string(variables('numGroups')) , 3,'0') )]",
               "groupMembers": "[variables('lastGroup')]",
                "conditionalMembership": ""
            }
        },
        {
            "type": "Microsoft.Network/networkManagers/connectivityConfigurations",
            "name": "[concat(parameters('networkManagerName'), '/', parameters('networkConnenctivtyConfigurationName'))]",
            "apiVersion": "2021-02-01-preview",
            "dependsOn": [
                "networkGroupCopy",
                "[resourceId(  'Microsoft.Network/networkManagers/networkGroups', parameters('networkManagerName'), concat ('grp',padleft(string(variables('numGroups')) , 3,'0'))   )]"
            ],
            "properties": {
                "displayName": "myConnectivityConfig",
                "description": "Sample of configuration hub-and-spoke",
                "connectivityTopology": "HubAndSpoke",
                "hubs": [
                    {
                        "resourceId": "[resourceId(subscription().subscriptionId, variables('hubvnet').resourceGroupName,'Microsoft.Network/virtualNetworks',variables('hubvnet').name)]",
                        "resourceType": "Microsoft.Network/virtualNetworks"
                    }
                ],
                "isGlobal": "True",
                "deleteExistingPeering": "True",
                "appliesToGroups": "[variables('appliesToGroups')]"
            }
        }
    ]
}