{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "locationhub": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "azure region where is deployed the first VNet"
            }
        },
        "location1": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "azure region where is deployed the first VNet"
            }
        },
        "location2": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "azure region where is deployed the second VNet"
            }
        },
        "location3": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "azure region where is deployed the second VNet"
            }
        },
        "location4": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "azure region where is deployed the second VNet"
            }
        },
        "resourceGroupNameHubVNet": {
            "type": "string",
            "defaultValue": "[resourceGroup().name]",
            "metadata": {
                "description": "name of the resource group with deployment of vnet1"
            }
        },
        "resourceGroupNameVNet1": {
            "type": "string",
            "defaultValue": "[resourceGroup().name]",
            "metadata": {
                "description": "name of the resource group with deployment of vnet1"
            }
        },
        "resourceGroupNameVNet2": {
            "type": "string",
            "defaultValue": "[resourceGroup().name]",
            "metadata": {
                "description": "name of the resource group with deployment of vnet2"
            }
        },
        "resourceGroupNameVNet3": {
            "type": "string",
            "defaultValue": "[resourceGroup().name]",
            "metadata": {
                "description": "name of the resource group with deployment of vnet3"
            }
        },
        "resourceGroupNameVNet4": {
            "type": "string",
            "defaultValue": "[resourceGroup().name]",
            "metadata": {
                "description": "name of the resource group with deployment of vnet4"
            }
        }
    },
    "variables": {
        "vNethub": {
            "resourceGroup": "[parameters('resourceGroupNameHubVNet')]",
            "location": "[parameters('locationhub')]",
            "name": "hub",
            "addressSpacePrefix": "10.0.0.0/24",
            "subnet1Name": "subnet1",
            "subnet1Prefix": "10.0.0.0/27",
            "subnet2Name": "subnet2",
            "subnet2Prefix": "10.0.0.224/27",
            "tag": "SHARED-vnet"
        },
        "vNet1": {
            "resourceGroup": "[parameters('resourceGroupNameVNet1')]",
            "location": "[parameters('location1')]",
            "name": "vnet1",
            "addressSpacePrefix": "10.0.1.0/24",
            "subnet1Name": "subnet1",
            "subnet1Prefix": "10.0.1.0/27",
            "subnet2Name": "subnet2",
            "subnet2Prefix": "10.0.1.224/27",
            "tag": "PROD-vnet"
        },
        "vNet2": {
            "resourceGroup": "[parameters('resourceGroupNameVNet2')]",
            "location": "[parameters('location2')]",
            "name": "vnet2",
            "addressSpacePrefix": "10.0.2.0/24",
            "subnet1Name": "subnet1",
            "subnet1Prefix": "10.0.2.0/27",
            "subnet2Name": "subnet2",
            "subnet2Prefix": "10.0.2.224/27",
            "tag": "PROD-vnet"
        },
        "vNet3": {
            "resourceGroup": "[parameters('resourceGroupNameVNet3')]",
            "location": "[parameters('location3')]",
            "name": "vnet3",
            "addressSpacePrefix": "10.0.3.0/24",
            "subnet1Name": "subnet1",
            "subnet1Prefix": "10.0.3.0/27",
            "subnet2Name": "subnet2",
            "subnet2Prefix": "10.0.3.224/27",
            "tag": "DEV-vnet"
        },
        "vNet4": {
            "resourceGroup": "[parameters('resourceGroupNameVNet4')]",
            "location": "[parameters('location4')]",
            "name": "vnet4",
            "addressSpacePrefix": "10.0.4.0/24",
            "subnet1Name": "subnet1",
            "subnet1Prefix": "10.0.4.0/27",
            "subnet2Name": "subnet2",
            "subnet2Prefix": "10.0.4.224/27",
            "tag": "DEV-vnet"
        },
        "vnetArray": [
            {
                "resourceGroup": "[variables('vNethub').resourceGroup]",
                "location": "[variables('vNethub').location]",
                "name": "[variables('vNethub').name]",
                "addressSpacePrefix": "[variables('vNethub').addressSpacePrefix]",
                "subnet1Name": "[variables('vNethub').subnet1Name]",
                "subnet1Prefix": "[variables('vNethub').subnet1Prefix]",
                "subnet2Name": "[variables('vNethub').subnet2Name]",
                "subnet2Prefix": "[variables('vNethub').subnet2Prefix]",
                "tag": "[variables('vNethub').tag]"
            },
            {
                "resourceGroup": "[variables('vNet1').resourceGroup]",
                "location": "[variables('vNet1').location]",
                "name": "[variables('vNet1').name]",
                "addressSpacePrefix": "[variables('vNet1').addressSpacePrefix]",
                "subnet1Name": "[variables('vNet1').subnet1Name]",
                "subnet1Prefix": "[variables('vNet1').subnet1Prefix]",
                "subnet2Name": "[variables('vNet1').subnet2Name]",
                "subnet2Prefix": "[variables('vNet1').subnet2Prefix]",
                "tag": "[variables('vNet1').tag]"
            },
            {
                "resourceGroup": "[variables('vNet2').resourceGroup]",
                "location": "[variables('vNet2').location]",
                "name": "[variables('vNet2').name]",
                "addressSpacePrefix": "[variables('vNet2').addressSpacePrefix]",
                "subnet1Name": "[variables('vNet2').subnet1Name]",
                "subnet1Prefix": "[variables('vNet2').subnet1Prefix]",
                "subnet2Name": "[variables('vNet2').subnet2Name]",
                "subnet2Prefix": "[variables('vNet2').subnet2Prefix]",
                "tag": "[variables('vNet2').tag]"
            },
            {
                "resourceGroup": "[variables('vNet3').resourceGroup]",
                "location": "[variables('vNet3').location]",
                "name": "[variables('vNet3').name]",
                "addressSpacePrefix": "[variables('vNet3').addressSpacePrefix]",
                "subnet1Name": "[variables('vNet3').subnet1Name]",
                "subnet1Prefix": "[variables('vNet3').subnet1Prefix]",
                "subnet2Name": "[variables('vNet3').subnet2Name]",
                "subnet2Prefix": "[variables('vNet3').subnet2Prefix]",
                "tag": "[variables('vNet3').tag]"
            },
            {
                "resourceGroup": "[variables('vNet4').resourceGroup]",
                "location": "[variables('vNet4').location]",
                "name": "[variables('vNet4').name]",
                "addressSpacePrefix": "[variables('vNet4').addressSpacePrefix]",
                "subnet1Name": "[variables('vNet4').subnet1Name]",
                "subnet1Prefix": "[variables('vNet4').subnet1Prefix]",
                "subnet2Name": "[variables('vNet4').subnet2Name]",
                "subnet2Prefix": "[variables('vNet4').subnet2Prefix]",
                "tag": "[variables('vNet4').tag]"
            }
        ],
        "vnetCount": "[length(variables('vnetArray'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[concat('vnet-deployment', copyIndex())]",
            "resourceGroup": "[variables('vnetArray')[copyIndex()].resourceGroup]",
            "dependsOn": [
            ],
            "copy": {
                "name": "vnetCopy",
                "count": "[variables('vnetCount')]"
            },
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Network/virtualNetworks",
                            "name": "[variables('vnetArray')[copyIndex()].name]",
                            "apiVersion": "2021-05-01",
                            "location": "[variables('vnetArray')[copyIndex()].location]",
                            "comments": "create the vnet",
                            "tags": {
                                "Environment": "[variables('vnetArray')[copyIndex()].tag]"
                            },
                            "properties": {
                                "addressSpace": {
                                    "addressPrefixes": [
                                        "[variables('vnetArray')[copyIndex()].addressSpacePrefix]"
                                    ]
                                },
                                "subnets": [
                                    {
                                        "name": "[variables('vnetArray')[copyIndex()].subnet1Name]",
                                        "properties": {
                                            "addressPrefix": "[variables('vnetArray')[copyIndex()].subnet1Prefix]"
                                        }
                                    },
                                    {
                                        "name": "[variables('vnetArray')[copyIndex()].subnet2Name]",
                                        "properties": {
                                            "addressPrefix": "[variables('vnetArray')[copyIndex()].subnet2Prefix]"
                                        }
                                    }
                                ]
                            }
                        }
                    ],
                    "outputs": {}
                }
            }
        }
    ]
}