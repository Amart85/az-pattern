{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "subscriptions": {
            "type": "array",
            "defaultValue": [
                "[concat('/subscriptions/',subscription().subscriptionId)]"
            ],
            "metadata": {
                "description": "subscription array"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location for all Network Manager."
            }
        },
        "networkManagerName": {
            "type": "string",
            "defaultValue": "ntw-mgr1",
            "metadata": {
                "description": "The name for Network Manager"
            }
        },
        "networkConnenctivtyConfigurationName": {
            "type": "string",
            "defaultValue": "netcfg1",
            "metadata": {
                "description": "network connectivty configuration"
            }
        },
        "resourceGroupNameHubVNet": {
            "type": "string",
            "defaultValue": "[resourceGroup().name]",
            "metadata": {
                "description": "name of the resource group with deployment of vnet1"
            }
        },
        "hubvnetName": {
            "type": "string",
            "defaultValue": "hub",
            "metadata": {
                "description": "name of the  hub vnet"
            }
        },
        "networkGroup1Name": {
            "type": "string",
            "defaultValue": "grp1",
            "metadata": {
                "description": "The name for Network Manager"
            }
        },
        "networkGroup2Name": {
            "type": "string",
            "defaultValue": "grp2",
            "metadata": {
                "description": "The name for Network Manager"
            }
        }
    },
    "variables": {
        "empty": [],
        "hubvnet": {
            "resourceGroupName": "[parameters('resourceGroupNameHubVNet')]",
            "name": "[parameters('hubvnetName')]"
        },
        "conditionalMembership1": "{ 
            \"allOf\": [
                {
                    \"field\": \"tags['Environment']\",
                    \"contains\": \"PROD\" 
                },
                {
                    \"field\": \"Name\", 
                    \"contains\": \"PROD\" 
                }
            ]
        }",
        "conditionalMembership2": "{ 
            \"allOf\": [
                {
                    \"field\": \"tags['Environment']\",
                    \"contains\": \"DEV\" 
                },
                {
                    \"field\": \"Name\", 
                    \"contains\": \"DEV\" 
                }
            ]
        }"
    },
    "resources": [
        {
            "name": "[parameters('networkManagerName')]",
            "type": "Microsoft.Network/networkManagers",
            "apiVersion": "2021-02-01-preview",
            "location": "[parameters('location')]",
            "properties": {
                "displayName": "[parameters('networkManagerName')]",
                "description": "basic Network Manager",
                "networkManagerScopes": {
                    "subscriptions": "[if(not(empty(parameters('subscriptions'))), parameters('subscriptions'), variables('empty'))]"
                },
                "networkManagerScopeAccesses": [
                    "Connectivity"
                ]
            }
        },
        {
            "name": "[concat(parameters('networkManagerName'), '/', parameters('networkGroup1Name'))]",
            "type": "Microsoft.Network/networkManagers/networkGroups",
            "apiVersion": "2021-02-01-preview",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkManagers', parameters('networkManagerName'))]"
            ],
            "properties": {
                "displayName": "[parameters('networkGroup1Name')]",
                "description": "network group1",
                "groupMembers": [],
                "conditionalMembership": "[variables('conditionalMembership1')]"
            }
        },
        {
            "name": "[concat(parameters('networkManagerName'), '/', parameters('networkGroup2Name'))]",
            "type": "Microsoft.Network/networkManagers/networkGroups",
            "apiVersion": "2021-02-01-preview",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkManagers', parameters('networkManagerName'))]"
            ],
            "properties": {
                "displayName": "[parameters('networkGroup2Name')]",
                "description": "network group 2",
                "groupMembers": [],
                "conditionalMembership": "[variables('conditionalMembership2')]"
            }
        },
        {
            "type": "Microsoft.Network/networkManagers/connectivityConfigurations",
            "name": "[concat(parameters('networkManagerName'), '/', parameters('networkConnenctivtyConfigurationName'))]",
            "apiVersion": "2021-02-01-preview",
            "dependsOn": [
                "[resourceId(subscription().subscriptionId, resourceGroup().name, 'Microsoft.Network/networkManagers/networkGroups', parameters('networkManagerName'),parameters('networkGroup1Name'))]",
                "[resourceId(subscription().subscriptionId, resourceGroup().name, 'Microsoft.Network/networkManagers/networkGroups', parameters('networkManagerName'),parameters('networkGroup2Name'))]"
            ],
            "properties": {
                "displayName": "myConnectivityConfig",
                "description": "Sample of configuration hub-and-spoke",
                "connectivityTopology": "HubAndSpoke",
                "hubs": [
                    {
                        "resourceId": "[resourceId(subscription().subscriptionId, variables('hubvnet').resourceGroupName,'Microsoft.Network/virtualNetworks',variables('hubvnet').name)]",
                        "resourceType": "Microsoft.Network/virtualNetworks"
                    }
                ],
                "isGlobal": "True",
                "deleteExistingPeering": "True",
                "appliesToGroups": [
                    {
                        "networkGroupId": "[resourceId(subscription().subscriptionId, resourceGroup().name, 'Microsoft.Network/networkManagers/networkGroups', parameters('networkManagerName'),parameters('networkGroup1Name'))]",
                        "useHubGateway": false,
                        "groupConnectivity": "DirectlyConnected",
                        "isGlobal": "False"
                    },
                    {
                        "networkGroupId": "[resourceId(subscription().subscriptionId, resourceGroup().name, 'Microsoft.Network/networkManagers/networkGroups', parameters('networkManagerName'),parameters('networkGroup2Name'))]",
                        "useHubGateway": false,
                        "groupConnectivity": "DirectlyConnected",
                        "isGlobal": "False"
                    }
                ]
            }
        }
    ]
}
