<properties
   pageTitle="interconnection of two hub-spoke VNet through libreswan"
   description="Interconnection of two Azure hub-spoke VNets through site-to-site VPN with libreswan"
   services=""
   documentationCenter="na"
   authors="fabferri"
   manager=""
   editor=""/>

<tags
   ms.service="Configuration-Example-Azure"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="01/07/2018"
   ms.author="fabferri" />

#  Interconnection of two Azure hub-spoke VNets through site-to-site VPN with libreswan
This article walks you through the steps to configure two Azure hub-spoke VNets in two different Azure regions. The interconnection is set by site-to-site VPN with libreswan, running in the Azure VMs connected to the hub VNets. The network diagram below shows an high level view of the network configuration.

[![1]][1]


In any Azure region the hub VNet and spoke VNet are connected by VNet peering.
The diagram shows the site-to-site VPN between the two Azure VMs in different Azure regions.


Here is a detailed network diagram of what we are going to achieve:

[![2]][2]

Name convention used in the article:
- Azure region1: northeurope
 - vNetSpoke1: Azure Spoke VNet in Azure region 1
 - spoke1: Azure VM connected to the spoke VNet, in Azure region 2
 - vNetHub1: Azure Hub VNet in Azure region 1
 - hub2: Azure VM with CentOS 7.4 OS and libreswan connected to vNetHub1 VNet
 - Spoke1toHub1: name of VNet peering between VNetSpoke1 and vNetHub1
 - Hub1toSpoke1: name of VNet peering between vNetHub1 and VNetSpoke1

- Azure regioni2: uksouth
 - vNetSpoke2: Azure Spoke VNet in Azure region 2
 - spoke2: Azure VM connected to the spoke VNet, in Azure region 2
 - vNetHub2: Azure Hub VNet in Azure region 2
 - hub2: Azure VM with CentOS 7.4 OS and libreswan connected to vNetHub2 VNet
 - Spoke2toHub2: name of VNet peering between VNetSpoke2 and vNetHub2
 - Hub2toSpoke2: name of VNet peering between vNetHub2 and VNetSpoke2

- site-to-site VPN between hub1 VM and hub2 VM

## <span style="color:darkblue"> <a name="CreateOU"></a>1. Build up the Azure enviroment</span>
Let's discuss the steps to make the setup. The full environment can be deployed with the following script files:

- **azureHubSpokeVNets.json**: unique azure template to deploy  hub-spoke VNets, VMs, VNet peering, Network Security Groups (NSGs), User Defined Routes (UDRs)
- **azureHubSpokeVNets.ps1**: powershell script used to run the **azureHubSpokeVNets.json** template.


Before running the powershell script:
1. set the name of Azure subscription in the powershell **azureHubSpokeVNets.ps1**
2. customize the parameters in the ARM file **azureHubSpokeVNets.json**: name of Azure regions, administrator account, administator password, size of Azure VM

> [!Note on **azureHubSpokeVNets.json**]
> The ARM template use arrays to create VNet, VNet peering, UDRs, NSGs. Changing the structure of different arrays can cause failure in the template due to inconsistency in allocation of resources. For example, if you change the address space in a VNets, be sure that you will change as well the private IP assigned to the VMs connected to the VNet.
> 


## <span style="color:darkblue"> <a name="CreateOU"></a>2	Libreswan setup in the Azure VMs connected the hub VNets</span>

Libreswan is an open-source, user-space IKE implementation available in Red Hat/CentOS.
Libreswan is a fork of Openswan. The paragraph describes the step to configure site-to-site VPN between two Azure VMs, named hub1 and hub2 with CentOS 7.4
The configuration use tunnel mode and the Pre-Shared Keys (PSK) authentication method. PSKs should consist of random characters and have a length of at least 20 characters.

Update the CentOS VMs:
	# yum -y update

To install Libreswan, enter the following command as root:
	# yum -y install libreswan

To check that Libreswan is installed: **yum info libreswan**

### <span style="color:darkblue"> <a name="CreateOU"></a>2.1	Generate the PSK</span>
A good practice to generate a PSK is to use openssl to generate a random string, by command:

    # openssl rand -base64 48 > psk.txt

The PSK can be generated in a txt file and copied by scp to the other VM to set the PSK. 
For testing purpose, in this article is used a readable short shared secret. In production the recommended practice is to use a PSK generated by openssl.


### <span style="color:darkblue"> <a name="CreateOU"></a>2.2	libreswan config files in Azure VM hub1</span>
Libreswan have two configuration files:
- **/etc/ipsec.conf**: the file specifies most configuration and control information
- **/etc/ipsec.secrets**: The file contains a list of secrets. Preshared secrets (PSKs) are stored in in this file.


Configuration in the file: **/etc/ipsec.conf**
```
config setup
	logfile=/var/log/pluto.log
	plutodebug="all"
    protostack=netkey
include /etc/ipsec.d/*.conf
```
The last statement includes all the files with extension **.conf** in the folder **/etc/ipsec.d/**

Create a new file: **#vi /etc/ipsec.d/host-to-host.conf**
```
conn mytunnel
	left=%defaultroute
	leftid=40.113.68.118
	leftsubnets={10.0.1.0/24 10.0.3.0/24}
    right=51.140.163.66
    rightid=51.140.163.66
    rightsubnets={10.0.2.0/24 10.0.4.0/24}
    authby=secret
    type=tunnel
    ikev2=yes
    esp=aes_gcm128-null
    mtu=1436
    # tunnel starts automatically
    auto=start
    dpdaction=restart
    dpddelay=10
    dpdtimeout=60
```

**/etc/ipsec.secrets**
```
include ipsec.*.secrets	# get secrets from other files
```

Create a new file: **vi /etc/ipsec.d/host-to-host.secrets**
```
41.40.113.68.118 51.140.163.66 : PSK "myAzureSharedSecret%321"
```

>  [!Note on **.conf** file ]

- **left**: the IP address of the left participant. When set to %defaultroute, left will be filled in automatically with the local address of the default-route interface.
- **leftid**: how the left participant should be identified for authentication. If preceded by @, the value is used as a literal string and will not be resolved.
- **leftsubnets**: specify multiple private subnets behind the left participant. If both a leftsubnets= and rightsubnets= are defined, all combinations of subnet tunnels will be established as IPsec tunnels
- authby: how the two security gateways should authenticate each other. The value **secret** is used for shared secrets (PSK) authentication.
- **auto**: both ends should use auto=start to ensure that any reboot causes immediate renegotiation.
- **dpddelay**: set the delay (in seconds) between Dead Peer Detection or IKEv2 Liveness keepalives that are sent for this connection. Set to enable checking. If dpddelay is set, dpdtimeout also needs to be set.
- **dpdtimeout**: Set the length of time (in seconds) that we will idle without hearing back from our peer. After this period has elapsed with no response and no traffic, we will declare the peer dead, and remove the SA. Set value bigger than dpddelay to enable. If dpdtimeout is set, dpddelay also needs to be set.
- **dpdaction**: When a DPD enabled peer is declared dead, what action should be taken. **restart** means that ALL SAs to the dead peer will renegotiated.


### <span style="color:darkblue"> <a name="CreateOU"></a>2.2	libreswan config files in Azure VM hub2</span>
Configuration in the file: **/etc/ipsec.conf**
```
config setup
	logfile=/var/log/pluto.log
	plutodebug="all"
    protostack=netkey
include /etc/ipsec.d/*.conf
```


Create a new file: **#vi /etc/ipsec.d/host-to-host.conf**
```
conn mytunnel
	left=%defaultroute
	leftid=40.113.68.118
	leftsubnets={10.0.1.0/24 10.0.3.0/24}
    right=51.140.163.66
    rightid=51.140.163.66
    rightsubnets={10.0.2.0/24 10.0.4.0/24}
    authby=secret
    type=tunnel
    ikev2=yes
    esp=aes_gcm128-null
    mtu=1436
    # tunnel starts automatically
    auto=start
    dpdaction=restart
    dpddelay=10
    dpdtimeout=60
```

**/etc/ipsec.secrets**
```
include ipsec.*.secrets	# get secrets from other files
```
Create a new file: **vi /etc/ipsec.d/host-to-host.secrets**
```
41.40.113.68.118 51.140.163.66 : PSK "myAzureSharedSecret%321"
```

### <span style="color:darkblue"> <a name="CreateOU"></a>2.3	enable IP forwarding in libreswan hosts</span>
Libreswan expects network parameters to be met to run without warnings: it is required to turn on the ip forwarding.

Add the following lines in **/etc/sysctl.conf**:
```
# IPSec
net.ipv4.ip_forward = 1

net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0

net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.send_redirects = 0

net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.conf.default.log_martians = 0

net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.all.rp_filter = 0
net.ipv4.conf.eth0.rp_filter = 0
```

for the changes to take effect immediately, run the following command as root:
	# sysctl -p

or the changes will take effect when you reboot the system.

### <span style="color:darkblue"> <a name="CreateOU"></a>2.4	Start the libreswan deamon</span>

To ensure that Libreswan will start when the system starts, issue the following command as root:

```
# systemctl enable ipsec.service
Created symlink from /etc/systemd/system/multi-user.target.wants/ipsec.service to /usr/lib/systemd/system/ipsec.service.
```

To ensure that ipsec daemon provided by libreswan start when the system starts, issue the following command as root:
```
# systemctl start ipsec.service
```
To confirm that the daemon is now running:
```
# systemctl status ipsec
```

Checking the libreswan version:
```
# ipsec version
Linux Libreswan 3.20 (netkey) on 3.10.0-693.21.1.el7.x86_64

# /usr/libexec/ipsec/pluto --version
Libreswan 3.20 XFRM(netkey) KLIPS USE_FORK USE_PTHREAD_SETSCHEDPRIO NSS USE_SYSTEMD_WATCHDOG FIPS_CHECK LABELED_IPSEC LIBCAP_NG LINUX_AUDIT XAUTH_PAM NETWORKMANAGER CURL(non-NSS) LDAP(non-NSS)

```


### <span style="color:darkblue"> <a name="CreateOU"></a>2.5	Verify the status of IPSec tunnels</span>
```
# ipsec setup status
# ipsec whack --trafficstattus
# ipsec status
# ip xfrm policy
# ip xfrm status
```
The **ipsec whack --trafficstattus** command shows the tunnels that are currently established:
```
# ipsec whack --trafficstatus
006 #1790: "mytunnel/1x1", type=ESP, add_time=1530563513, inBytes=0, outBytes=0, id='51.140.112.196'
006 #1805: "mytunnel/1x1", type=ESP, add_time=1530563634, inBytes=0, outBytes=0, id='51.140.112.196'
006 #1820: "mytunnel/1x1", type=ESP, add_time=1530563754, inBytes=0, outBytes=0, id='51.140.112.196'
006 #2010: "mytunnel/1x1", type=ESP, add_time=0, inBytes=0, outBytes=0, id='51.140.112.196'
006 #2014: "mytunnel/1x1", type=ESP, add_time=1530565197, inBytes=0, outBytes=0, id='51.140.112.196'
006 #2011: "mytunnel/1x2", type=ESP, add_time=0, inBytes=0, outBytes=0, id='51.140.112.196'
006 #2016: "mytunnel/1x2", type=ESP, add_time=1530565197, inBytes=0, outBytes=0, id='51.140.112.196'
006 #2012: "mytunnel/2x1", type=ESP, add_time=0, inBytes=0, outBytes=0, id='51.140.112.196'
006 #2015: "mytunnel/2x1", type=ESP, add_time=1530565197, inBytes=0, outBytes=0, id='51.140.112.196'
006 #2013: "mytunnel/2x2", type=ESP, add_time=0, inBytes=0, outBytes=0, id='51.140.112.196'
006 #2017: "mytunnel/2x2", type=ESP, add_time=1530565197, inBytes=0, outBytes=0, id='51.140.112.196'

```
The **ipsec status** command shows a more verbose but not very user-friendly output.It is not really designed for administrators.

The kernel IPsec state consists of two parts:
- The Security Policy Database (SPD): issue the command **ip xfrm policy**
- the Security Association Database (SAD): issue the comand **ip xfrm state**
They are linked together by the _reqid_.

### <span style="color:darkblue"> <a name="CreateOU"></a>2.5	How to track the traffic</span>
To verify that packets are being sent via the VPN tunnel, issue a command as root in the following format:
```
tcpdump -n -i eth0 esp or udp port 500 or udp port 4500
```

#### Debug ###
As specified in the **/etc/ipsec.conf file**, the libreswan's message logs generated by the daemon are written in the file: **/var/log/pluto.log**.




<!--Image References-->

[1]: ./media/high-level-diagram.png "High level network diagram"
[2]: ./media/network-diagram.png "Network diagram.png"


<!--Link References-->


