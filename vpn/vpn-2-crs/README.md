<properties
   pageTitle="Site-to-site VPN between two Cisco CSR 1000v in Azure"
   description="Site-to-site VPN between two Cisco CSR 1000v in Azure"
   services="S2S VPN"
   documentationCenter="github"
   authors="fabferri"
   manager=""
   editor=""/>

<tags
   ms.service="configuration-Example-Azure"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="01/03/2022"
   ms.author="fabferri" />

##  Site-to-site VPN between two Cisco CSR 1000v in Azure

Azure marketplace offers a large number of Network Virtual Appliances (NVAs). In this article is reported the configuration of VPN IPSec tunnel between two Cisco 1000v deployed in different Azure Virtual Networks (VNets).

The network diagram is shown below:

[![1]][1]

The configuration is based on Virtual Tunnel Interfaces (VTIs); the network diagram reports the termination of IPSec tunnel on the VTIs. The two interface tunnels (tunnel1 in csr1 and tunnel1 in csr2) are reachable through static routing.

[![2]][2]

## <a name="List of files"></a>1. List of files 
An effective way to deploy Cisco CSR 1000v is to use Azure Resource Manager (ARM) templates.

| file                    | description                                                        |       
| ----------------------- |:------------------------------------------------------------------ |
| **01_csr.json**         | ARM template to create vnets and VMs                               |
| **01_csr.ps1**          | powershell script to deploy the ARM template **01_csr.ps1**        |
| **image.ps1**           | powershell script to select the specific CSR image available in Azure markeplace |
| **accept-marketTerms.ps1**    | powershell script to accept teams and condition of specific CSR license in Azure markeplace |
| **generate-config-csr1.ps1**  | powershell script to create the configuration file for the cisco csr1. <br> The csr1 configuration is written in the text file: **csr1-config.txt**    |
| **generate-config-csr2.ps1**  | powershell script to create the configuration file for the cisco csr2. <br> The csr2 configuration is written in the text file: **csr2-config.txt**    |
| **csr1-config.txt**     | configuration file for csr1 generated by the powershell script **generate-config-csr1.ps1**|
| **csr2-config.txt**     | configuration file for csr2 generated by the powershell script **generate-config-csr2.ps1**|

Before spinning up the powershell scripts, you have to edit and customize the values of variables in the file **init.json**:
```json
{
    "subscriptionName": "AZURE_SUBSCRIPTION_NAME",
    "ResourceGroupName": "NAME_RESOURCE_GROUP",
    "location1": "AZURE_REGION_VNET1_AND_CSR1",
    "location2": "AZURE_REGION_VNET2_AND_CSR2",
    "csr1Name": "NAME_CSR1",
    "csr2Name": "NAME_CSR2",
    "sharedKey": "PRESHARED_KEY_IPsec_TUNNEL",
    "adminUsername": "ADMINISTRATOR_USERNAME",
    "adminPassword": "ADMINISTRATOR_PASSWORD",
    "mngIP": "MANAGEMENT_PUBLIC_IP_TO_CONNECT_TO_AZURE_VMs_AND_CSRs",
    "RGTagExpireDate": "04/01/2022",
    "RGTagContact": "user1@contoso.com",
    "RGTagNinja": "user",
    "RGTagUsage": "S2S VPN between two CSRs"
}
```


## <a name="configuration csr1"></a>2. Configuration csr1

```console
interface GigabitEthernet2
 ip address dhcp
 no shut
!
!
interface Loopback0
 ip address 192.168.0.1 255.255.255.255
 no shut
!
crypto ikev2 proposal az-PROPOSAL
 encryption aes-cbc-256 aes-cbc-128 3des
 integrity sha1
 group 2
!
crypto ikev2 policy az-POLICY
 proposal az-PROPOSAL
!
crypto ikev2 keyring key-peer11
 peer azvpn1
  address <remotecsr2Pub>
  pre-shared-key <PRE_SHARED_KEY>
!
!
!
crypto ikev2 profile az-PROFILE1
 match address local interface GigabitEthernet1
 match identity remote address <remotecsr2PrivIP> 255.255.255.255
 authentication remote pre-share
 authentication local pre-share
 keyring local key-peer11
!
!
crypto ipsec transform-set az-IPSEC-PROPOSAL-SET esp-aes 256 esp-sha-hmac
 mode tunnel
!
crypto ipsec profile az-VTI1
 set transform-set az-IPSEC-PROPOSAL-SET
 set ikev2-profile az-PROFILE1
!
interface Tunnel1
 ip address 172.16.0.1 255.255.255.255
 ip tcp adjust-mss 1350
 tunnel source GigabitEthernet1
 tunnel mode ipsec ipv4
 tunnel destination <remotecsr2PubIP>
 tunnel protection ipsec profile az-VTI1
!
!
router bgp 65001
 bgp router-id interface Loopback0
 bgp log-neighbor-changes
 neighbor <remotecsr2PrivIP> remote-as 65002
 neighbor <remotecsr2PrivIP> ebgp-multihop 3
 neighbor <remotecsr2PrivIP> update-source GigabitEthernet1
 !
 address-family ipv4
  network 10.0.0.0 mask 255.255.255.224
  network 10.0.0.32 mask 255.255.255.224
  network 10.0.0.64 mask 255.255.255.224
  network 10.0.0.96 mask 255.255.255.224
  neighbor <remotecsr2PrivIP> activate
  neighbor <remotecsr2PrivIP> next-hop-self
  neighbor <remotecsr2PrivIP> soft-reconfiguration inbound

 exit-address-family
!
crypto ikev2 dpd 10 2 on-demand
!
! route set by ARM template
!ip route 0.0.0.0 0.0.0.0 10.0.0.1
!
!
ip route <remotecsr2PrivIP> 255.255.255.255 Tunnel1
ip route 10.0.0.64 255.255.255.224 10.0.0.33
ip route 10.0.0.96 255.255.255.224 10.0.0.33
!
!
line vty 0 4
 exec-timeout 25 0
exit
```


## <a name="configuration csr2"></a>3. Configuration csr2

```console
interface GigabitEthernet2
 ip address dhcp
 no shut
!
!
interface Loopback0
 ip address 192.168.2.1 255.255.255.255
 no shut
!
crypto ikev2 proposal az-PROPOSAL
 encryption aes-cbc-256 aes-cbc-128 3des
 integrity sha1
 group 2
!
crypto ikev2 policy az-POLICY
 proposal az-PROPOSAL
!
crypto ikev2 keyring key-peer21
 peer azvpn1
  address <remotecsr1PubIP>
  pre-shared-key <PRE_SHARED_KEY>
!
!
!
crypto ikev2 profile az-PROFILE1
 match address local interface GigabitEthernet1
 match identity remote address <remotecsr1privIP> 255.255.255.255
 authentication remote pre-share
 authentication local pre-share
 keyring local key-peer21
!
!
crypto ipsec transform-set az-IPSEC-PROPOSAL-SET esp-aes 256 esp-sha-hmac
 mode tunnel
!
crypto ipsec profile az-VTI1
 set transform-set az-IPSEC-PROPOSAL-SET
 set ikev2-profile az-PROFILE1
!
interface Tunnel1
 ip address 172.16.0.2 255.255.255.255
 ip tcp adjust-mss 1350
 tunnel source GigabitEthernet1
 tunnel mode ipsec ipv4
 tunnel destination <remotecsr1PubIP>
 tunnel protection ipsec profile az-VTI1
!
!
router bgp 65002
 bgp router-id interface Loopback0
 bgp log-neighbor-changes
 neighbor <remotecsr1privIP> remote-as 65001
 neighbor <remotecsr1privIP> ebgp-multihop 3
 neighbor <remotecsr1privIP> update-source GigabitEthernet1
 !
 address-family ipv4
  network 10.0.2.0 mask 255.255.255.224
  network 10.0.2.32 mask 255.255.255.224
  network 10.0.2.64 mask 255.255.255.224
  network 10.0.2.96 mask 255.255.255.224
  neighbor <remotecsr1privIP> activate
  neighbor <remotecsr1privIP> next-hop-self
  neighbor <remotecsr1privIP> soft-reconfiguration inbound

 exit-address-family
!
crypto ikev2 dpd 10 2 on-demand
!
! route set by ARM template
!ip route 0.0.0.0 0.0.0.0 10.0.2.1
!
!
ip route <remotecsr1privIP> 255.255.255.255 Tunnel1
ip route 10.0.2.64 255.255.255.224 10.0.2.33
ip route 10.0.2.96 255.255.255.224 10.0.2.33
!
!
line vty 0 4
 exec-timeout 25 0
exit
```

### Note ###
The command: 
<br>
crypto ikev2 dpd *interval* *retry-interval* on-demand
<br>

verifies if IKE is live on the peer, by sending keepalive before sending data.

## <a name="check configurations"></a>4. Check the configurations

In order to verify the configuration use few show commands:

- **show ip interface brief**
- **show crypto session**
- **show crypto session detail**
- **show crypto ikev2 sa**
- **show crypto ikev2 session detail** 
- **show crypto ipsec sa**
- **clear crypto sa** [delete the SA and wait that the new association is recreated successfully]
- **show ip bgp**
- **show ip bgp neighbors**
- **show ip route**

Connect to the vm1 in SSH and ping the remote vm2.

## <a name="check configurations"></a>5. NAT to breakout in internet through crs
The Azure vm1 can access to internet through the transit in csr1. This can can be achieved by  NAT overload applied to the egress interface gigabitEthernet1. When configuring a site-to-site VPN tunnel, it is imperative to instruct the router not to perform NAT (deny NAT) on packets destined to the remote VPN networks. This is easily done by inserting a deny statement at the beginning of the NAT access lists:

```console
interface gigabitethernet 2
 ip nat inside
!
interface gigabitethernet 1
 ip nat outside
!
ip access-list extended NAT 
 deny   ip 10.0.0.0 0.0.0.31 10.0.2.0 0.0.0.31
 deny   ip 10.0.0.32 0.0.0.31 10.0.2.32 0.0.0.31
 deny   ip host 172.16.0.1 host 172.16.0.2
 permit ip 10.0.0.96 0.0.0.31 any
!
ip nat inside source list NAT interface gigabitethernet 1 overload 
```
To send the taffic to internet is required the presence of UDR applied to the **subnetworkload2** of vnet1:
```
dest network: 0.0.0.0 0.0.0.0, next-hop type: virtual appliace, next-hop IP: 10.0.1.50
```

To check the NAT table:
```console
show ip nat translations
show ip nat statistics
```
To clean up the NAT translation:
```console
clear ip nat translation *
```


## <a name="ANNEX"></a>6. ANNEX
As described in Cisco documentation, IKEv2 protocol in Cisco IOS software is based on following constructs:

- **IKEv2 Proposal** (required). An IKEv2 proposal is a collection of transforms used in the negotiation of IKE SAs as part of the IKE_SA_INIT exchange. 
<br> The transform types used in the negotiation are as follows:
	- Encryption algorithm
	- Integrity algorithm
	- Pseudo-Random Function (PRF) algorithm
	- Diffie-Hellman (DH) group

   IKEv2 proposals are named and not numbered during the configuration. Manually configured IKEv2 proposals must be linked with an **IKEv2 policy** otherwise, the proposals are not used in the negotiation.<br>
   Multiple transforms can be configured and proposed by the initiator for encryption, integrity, and group, of which one transform is selected by the responder. When multiple transforms are configured for a transform type, the order of priority is from left to right.

- **IKEv2 Policy** (required). You must configure at least one encryption algorithm, one integrity algorithm, and one DH group for the proposal to be considered complete. An IKEv2 policy contains proposals that are used to negotiate the encryption, integrity, PRF algorithms, and DH group in SA_INIT exchange. It can have match statements which are used as selection criteria to select a policy during negotiation.
- **IKEv2 Profile** (required). An IKEv2 profile is a repository of the nonnegotiable parameters of the IKE SA, such as local or remote identities and authentication methods and the services that are available to the authenticated peers that match the profile. An IKEv2 profile must be attached to either crypto map or IPSec profile on both IKEv2 initiator and responder.
- **IKEv2 Keyring** (required). An IKEv2 keyring is a repository of symmetric and asymmetric preshared keys. The IKEv2 keyring is associated with an IKEv2 profile and hence, caters to a set of peers that match the IKEv2 profile. The IKEv2 keyring gets its VRF context from the associated IKEv2 profile.

### REFERENCE
[http://www.cisco.com/c/en/us/td/docs/ios/sec_secure_connectivity/configuration/guide/convert/sec_ike_for_ipsec_vpns_15_1_book/sec_cfg_ikev2.html](http://www.cisco.com/c/en/us/td/docs/ios/sec_secure_connectivity/configuration/guide/convert/sec_ike_for_ipsec_vpns_15_1_book/sec_cfg_ikev2.html "Internet Key Exchange for IPsec VPNs Configuration Guide")

<!--Image References-->

[1]: ./media/network-diagram1.png "Network topology" 
[2]: ./media/network-diagram2.png "Network topology" 

<!--Link References-->



